# 常见问题和故障排查

本文档整理了使用 NextCloud Doc Publisher 插件时的常见问题、使用技巧和故障排查方法。

## 目录

1. [快速诊断](#1-快速诊断)
2. [常见问题](#2-常见问题)
3. [故障排查](#3-故障排查)
4. [使用技巧](#4-使用技巧)

---

## 1. 快速诊断

### 1.1 执行测试连接

```
Ctrl + Shift + P → "NextCloud Doc Publisher: Test Connection"
```

测试命令会显示详细的诊断信息，帮助您快速定位问题。

### 1.2 查看日志输出

测试命令会显示：
- WebDAV URL
- 用户名配置
- 根目录文件列表
- 详细的错误信息和建议

---

## 2. 常见问题

### 2.1 配置相关

**Q1: 如何验证插件配置正确？**

A: 在命令面板中执行：
```
1. 按 Cmd/Ctrl + Shift + P 打开命令面板
2. 输入 "NextCloud Doc Publisher: Test Connection"
3. 查看连接测试结果
```
插件会测试NextCloud连接、验证配置并显示详细诊断信息。

**Q2: 如何获取正确的 WebDAV 地址？**

A: 按照以下步骤获取：
```
1. 登录 NextCloud 网页版
2. 左下角点击 "文件设置"（齿轮图标）
3. 在设置面板左侧选择 "WebDAV"
4. 复制显示的 WebDAV 地址
5. 从地址中提取：
   - url: 服务器地址部分
   - webdavUsername: 地址最后的用户名部分
```

**示例：**
- WebDAV 地址：`https://docs.streamax.com:18001/remote.php/dav/files/chengang_3074`
- 配置：
  - `url`: `https://docs.streamax.com:18001`
  - `webdavUsername`: `chengang_3074`

### 2.2 功能相关

**Q3: 支持哪些资源文件格式？**

A: 支持所有格式，包括：
- 图片：png、jpg、gif、svg、webp
- 文档：pdf、docx、xlsx、pptx
- 其他：txt、json、xml、zip等

**Q4: 多个文档如何管理？**

A: 在同一版本目录下创建多个.md文件，插件会自动处理所有文档：
```
doc/V2.16.13/design/
├── 设计文档A.md
├── 设计文档B.md
├── 设计文档C.md
└── assets/
```

**Q5: 资源文件更新后需要重新发布吗？**

A: 是的。如果修改了assets中的文件，需要重新执行发布命令，插件会自动覆盖旧文件。

**Q6: 单个文档发布和批量发布有什么区别？**

A: 主要区别：
- **单个文档发布**：只发布当前打开的文档，只上传该文档引用的资源，速度快
- **批量发布**：发布整个目录下的所有文档，上传所有资源，确保完整性

建议：日常更新用单个发布，首次发布或版本发布用批量发布。

**Q7: 如何只发布单个文档而不发布整个目录？**

A: 
1. 在Cursor中打开要发布的Markdown文件
2. 按 `Cmd/Ctrl + Shift + U`（快捷键）
3. 或在文件树中右键点击该文件 -> "Publish to NextCloud"

**Q8: 发布单个文档时，其他文档会受影响吗？**

A: 不会。单个文档发布只会：
- 上传/更新当前文档
- 上传/更新当前文档引用的资源
- 不会影响目录下的其他文档

**Q9: 批量发布会覆盖之前发布的文档吗？**

A: 会。批量发布会：
- 上传目录下的所有Markdown文件
- 如果NextCloud已存在同名文档，会被覆盖
- 所有资源文件也会被重新上传

### 2.3 上传和访问相关

**Q10: NextCloud分享链接无法访问？**

A: 检查以下几点：
- NextCloud分享功能是否启用
- 分享链接权限是否为"公开"
- 网络是否可访问NextCloud服务器
- 防火墙或代理设置

**Q11: 如何删除已发布的文档？**

A: 登录NextCloud Web界面，在您选择的上传目录下手动删除。

**Q12: 如何组织不同类型的文档？**

A: 插件支持任意目录结构，推荐以下几种方式：

**推荐方式（版本+类型）：**
```
doc/
├── V2.16.13/          # 当前版本
│   ├── design/        # 设计文档
│   ├── requirements/  # 需求文档
│   ├── api/          # API文档
│   └── tech/         # 技术文档
└── V2.16.12/          # 历史版本
```

**简化方式（仅类型）：**
```
doc/
├── design/      # 设计文档
├── requirements/ # 需求文档
├── api/         # API文档
└── tech/        # 技术文档
```

插件会完整保留您选择的任何目录结构。

### 2.4 其他问题

**Q13: 插件是否支持离线工作？**

A: 插件需要网络连接才能上传到NextCloud。编写文档可以离线进行，发布时需要联网。

**Q14: 可以发布非设计类的文档吗？**

A: 可以！插件支持发布任何类型的Markdown文档，包括需求文档、技术方案、API文档、运维手册等。

---

## 3. 故障排查

### 3.1 连接问题

#### ❌ 403 Forbidden

**症状：**
```
[ERROR] 403 Forbidden
```

**原因：**
1. 使用了登录密码而不是应用专用密码
2. 用户没有写入权限
3. WebDAV文件空间用户名配置错误

**解决方法：**

✅ **检查应用专用密码**
- 必须使用应用专用密码，不能使用登录密码
- 参考：[使用指南](./USAGE_GUIDE.md#12-创建应用专用密码)

✅ **检查权限**
- 确认用户有写入权限
- 尝试在NextCloud网页版手动上传文件测试

✅ **检查WebDAV配置**
- 确认WebDAV文件空间用户名配置正确（必填）
- 参考：[使用指南](./USAGE_GUIDE.md#2-配置)

#### ❌ 401 Unauthorized

**症状：**
```
[ERROR] 401 Unauthorized
```

**原因：**
- 用户名或密码错误
- 应用专用密码过期或被撤销
- WebDAV 用户名配置不正确

**解决方法：**

✅ **检查用户名**
- 确认用户名正确（通常是登录用户名）
- 检查是否需要配置 WebDAV文件空间用户名

✅ **重新创建应用专用密码**
- 在 NextCloud 安全设置中删除旧密码
- 创建新的应用专用密码
- 更新插件配置

✅ **检查 WebDAV 地址格式**
1. 登录 NextCloud 网页版
2. 点击右下角设置（齿轮图标）
3. 查看 WebDAV 地址

**如果显示 `username_数字` 格式：**
```
https://nextcloud.com/remote.php/dav/files/chengang_3074
```

需要分别配置：
- **Username**: `chengang`（不带数字）
- **WebDAV文件空间用户名**: `chengang_3074`（完整名称）
- **Password**: 用 `chengang` 创建的应用专用密码

#### ❌ 404 Not Found

**症状：**
```
[ERROR] 404 Not Found
```

**原因：**
- 上传目录不存在（发布时输入的目录路径错误）
- URL 配置错误
- WebDAV文件空间用户名配置错误

**解决方法：**

✅ **检查上传目录**
- 发布时输入的上传目录路径必须存在或可创建
- 确保目录路径拼写正确（区分大小写）
- 插件会自动创建目录，但需要用户有创建权限

✅ **检查 URL**
- 确认 NextCloud URL 正确
- URL 末尾不要加斜杠（插件会自动处理）

✅ **检查WebDAV配置**
- 确认WebDAV文件空间用户名配置正确（必填）

### 3.2 认证问题

#### 空目录列表（0 个项目）

**症状：**
```
[INFO] 根目录下有 0 个项目：
```

**原因：**
- 个人空间为空或未启用
- WebDAV 访问的空间与网页版不同
- WebDAV用户名配置不正确

**解决方法：**

✅ **检查 WebDAV 用户名**
- 查看 NextCloud 设置中的 WebDAV 地址
- 如果是 `username_数字` 格式，必须配置 WebDAV文件空间用户名（必填）
- 参考：[使用指南](./USAGE_GUIDE.md#2-配置)

✅ **测试创建目录**
- 发布时会自动创建上传目录
- 如果创建失败，检查用户权限

### 3.3 路径问题

#### 上传目录路径错误

**路径规则：**
- 上传目录在发布时动态选择或输入
- 支持任意路径结构，如：`/Docs/V2.16.13/design`
- 插件会自动创建目录结构
- 历史记录会自动保存，方便重复使用

**建议的目录结构：**
- 按版本组织：`/Docs/V2.16.13/design`
- 按项目组织：`/Docs/项目名/文档类型`
- 按团队组织：`/Docs/团队/项目/版本`

**常见问题：**
- 如果目录创建失败，检查用户是否有创建权限
- 确保路径格式正确（以 `/` 开头）
- 历史记录可以在目录选择对话框中管理

### 3.4 高级问题

#### URL 末尾有双斜杠

**症状：**
```
https://nextcloud.com:18001//remote.php/dav/files/...
                         ^^
```

**原因：**
- NextCloud URL 配置时末尾包含了斜杠

**解决方法：**
- 插件会自动移除末尾的斜杠
- 或手动修改配置，删除 URL 末尾的 `/`

#### WebDAV 用户名与登录用户名不同

**背景：**
某些 NextCloud 配置（特别是企业环境）会使用不同的标识：
- 登录用户名：`chengang`
- WebDAV 用户名：`chengang_3074`

**识别方法：**
1. 登录 NextCloud 网页版
2. 右下角设置 → WebDAV
3. 查看显示的 WebDAV 地址

**配置示例：**

```json
{
  "nextcloud": {
    "username": "chengang",              // 用于认证
    "webdavUsername": "chengang_3074",   // 用于访问文件
    "password": "xxxxx-xxxxx..."         // 应用专用密码
  }
}
```

#### 群组文件夹与个人空间

**个人空间：**
```
文件（Files）
├── Documents
├── Photos
└── test
```

**群组文件夹：**
```
文件（Files）
└── 云平台开发部  ← 群组文件夹（共享空间）
    ├── 平台研发
    └── ...
```

**配置说明：**
- 插件支持个人空间和群组文件夹
- 上传目录在发布时选择，可以是任意路径
- 如果使用群组文件夹，上传目录从群组文件夹开始（如：`/云平台开发部/平台研发/...`）

### 3.5 调试技巧

#### 1. 使用测试连接命令

在每次配置更改后，执行测试连接：
```
Ctrl + Shift + P → "NextCloud Doc Publisher: Test Connection"
```

#### 2. 查看详细日志

测试连接会显示：
- 配置信息
- WebDAV URL
- 根目录文件列表
- 详细的错误信息

#### 3. 逐步验证

按顺序检查：
1. URL 和认证 → 401/403 错误
2. 文件列表 → 空目录或权限问题
3. WebDAV配置 → WebDAV文件空间用户名是否正确（必填）
4. 文件上传 → 实际发布

---

## 4. 使用技巧

### 4.1 根据场景选择发布模式

**场景A：编写完单个文档，立即发布**
- 使用"单个文档发布"
- 快捷键：`Cmd/Ctrl + Shift + U`
- 优势：速度快，只上传相关资源

**场景B：首次发布或版本发布**
- 使用"目录批量发布"
- 右键点击目录 -> "Publish Directory to NextCloud"
- 优势：确保所有文档同步

**场景C：更新已发布的文档**
- 修改文档后，使用"单个文档发布"
- 插件会自动覆盖NextCloud上的旧版本

### 4.2 批量发布多个文档

如果在同一版本目录下有多个Markdown文档：

```
doc/V2.16.13/design/
├── 用户管理设计.md
├── 权限设计.md
├── 数据迁移方案.md
└── assets/
```

使用"目录批量发布"模式，插件会自动处理所有文档。

### 4.3 按文档类型组织

推荐按文档类型创建子目录：

```bash
# 推荐：按版本组织（便于历史追溯）
doc/V2.16.13/design/
doc/V2.16.13/requirements/
doc/V2.16.13/api/
doc/V2.16.13/tech/

# 或：不使用版本目录
doc/design/
doc/requirements/
doc/api/
doc/tech/
```

发布时可以选择发布特定类型的文档。

### 4.4 查看发布历史

Cursor插件会在输出面板显示详细日志：

1. 打开输出面板：`Cmd/Ctrl + Shift + U`
2. 选择 "NextCloud Doc Publisher" 通道
3. 查看发布历史和详细日志

### 4.5 使用环境变量

在配置文件中使用环境变量，避免硬编码敏感信息：

```json
{
  "nextcloud": {
    "url": "${env:NEXTCLOUD_URL}",
    "username": "${env:NEXTCLOUD_USERNAME}",
    "password": "${env:NEXTCLOUD_PASSWORD}",
    "webdavUsername": "${env:NEXTCLOUD_WEBDAV_USERNAME}"
  }
}
```

### 4.6 管理上传目录历史

- 发布时会自动保存使用的上传目录到历史记录
- 最多保存20条历史记录
- 在目录选择对话框中可以直接删除不需要的历史记录
- 方便快速选择和重复使用常用目录

---

**相关文档**：
- [使用指南](USAGE_GUIDE.md) - 配置和使用完整教程
- [开发指南](DEVELOPMENT.md) - 开发相关文档
